#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const { spawnSync } = require('child_process');
const glob = require('glob');
const pkg = require('../package.json');
const { getProjectType, getProjectFramework, getProjectLanguageType } = require('@appworks/project-utils');

const jscodeshiftExecutable = require.resolve('.bin/jscodeshift');

const args = process.argv.slice(2);

if (args.length === 1) {
  if (args[0] === '-v' || args[0] === '--version') {
    console.log(pkg.version);
    process.exit();
  } else {
    console.log(
      'Codemods for updating Rax and React APIs.\n' +
      'Usage\n' +
      '$ appworks-codemod <transform> <path> [...options?]\n' +
      '  transform    One of the choices from https://github.com/appworks-lab/codemod/blob/master/transforms/docs\n' +
      '  path         directory to transform. \n' +
      '  Options for jscodeshift https://www.npmjs.com/package/jscodeshift like:\n' +
      '  --dry              Dry run (no changes are made to files)\n' +
      '  --print            Print transformed files to your terminal',
    );
    process.exit();
  }
} else {
  run();
}

// npx @appworks/codemod <transform> <path> [...options?]
async function run() {
  const [transform, target] = args;

  let dir;
  let files;
  let transformFile;

  try {
    transformFile = require.resolve(path.join(__dirname, '../transforms/', transform));
    // Get target files
    if (fs.statSync(target).isFile()) {
      dir = path.dirname(target);
      files = [target];
    } else {
      dir = target;
      files = glob.sync('**/*', { cwd: target, ignore: ['**/node_modules/**'], nodir: true, realpath: true });
    }
  } catch (e) {
    // Check transform and target
    if (!transformFile) {
      console.log(`Transform '${transform}' not found, please check.`);
    } else {
      console.log(`Path '${target}' not found, please check.`);
    }
    process.exit();
  }

  let jscodeshiftArgs = [];
  jscodeshiftArgs = jscodeshiftArgs.concat(['--transform', transformFile]);
  jscodeshiftArgs = jscodeshiftArgs.concat(files);

  if (args.length > 2) {
    jscodeshiftArgs = jscodeshiftArgs.concat(args.slice(2));
  }

  jscodeshiftArgs = jscodeshiftArgs.concat([
    `--projectType=${await getProjectType(dir, true)}`,
    `--projectFramework=${await getProjectFramework(dir)}`,
    `--projectLanguageType=${await getProjectLanguageType(dir)}`,
  ]);

  spawnSync(jscodeshiftExecutable, jscodeshiftArgs, {
    stdio: 'inherit',
    stripEof: false,
  });
}
